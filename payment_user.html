<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body class="p-4">
    <div class="container">
        <h3>Passenger Details & Payment</h3>
        <div id="error-msg" class="alert alert-danger d-none"></div>

        <form id="payment-form">
            <div class="mb-3"><label>Passenger Name</label><input type="text" name="passenger_name" class="form-control"
                    required></div>
            <div class="mb-3"><label>Email</label><input type="email" name="email" class="form-control" required></div>
            <div class="mb-3"><label>Phone</label><input type="text" name="phone" class="form-control" required></div>
            <div class="mb-3"><label>From</label><input type="text" name="from_location" class="form-control" required>
            </div>
            <div class="mb-3"><label>To</label><input type="text" name="to_location" class="form-control" required>
            </div>
            <div class="mb-3"><label>Travel Date</label><input type="date" name="travel_date" id="travel_date"
                    class="form-control" readonly></div>
            <div class="mb-3"><label>Selected Seats</label><input type="text" name="seats_display" id="seats_display"
                    class="form-control" readonly></div>
            <div class="mb-3"><label>Number of Seats</label><input type="number" name="number_of_seats"
                    id="number_of_seats" class="form-control" readonly></div>
            <div class="mb-3">
                <label>UPI / Scan QR</label>
                <input type="text" name="upi_id" class="form-control" required value="your-upi@bank">
                <div class="mt-2">
                    <img src="https://api.qrserver.com/v1/create-qr-code/?data=your-upi@bank&size=150x150" alt="UPI QR">
                </div>
            </div>


            <!-- Hidden fields to send to backend -->
            <input type="hidden" name="bus_id" id="bus_id">
            <input type="hidden" name="seats" id="seats">

            <button type="submit" class="btn btn-success">Payment Done</button>
        </form>
    </div>

    <script>
        // Get parameters from URL
        const urlParams = new URLSearchParams(window.location.search);
        const busId = urlParams.get('bus_id');
        const seats = urlParams.get('seats');
        const travelDate = urlParams.get('date');

        if (!busId || !seats || !travelDate) {
            const errorDiv = document.getElementById('error-msg');
            errorDiv.textContent = "Error: Bus ID, seats, or travel date missing! Please select your seats first.";
            errorDiv.classList.remove('d-none');
            document.getElementById('payment-form').style.display = 'none';
        } else {
            // Fill hidden fields for backend
            document.getElementById('bus_id').value = busId;
            document.getElementById('seats').value = seats;

            // Show info to user
            document.getElementById('travel_date').value = travelDate;
            document.getElementById('seats_display').value = seats;
            document.getElementById('number_of_seats').value = seats.split(',').length;
        }

        // Handle form submission
        document.getElementById('payment-form').addEventListener('submit', function (e) {
            e.preventDefault();

            fetch('api/save_booking.php', {
                method: 'POST',
                body: new FormData(this)
            })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        alert("Booking Successful!");
                        window.location.href = 'index_user.html';
                    } else {
                        alert("Error: " + data.error);
                    }
                })
                .catch(err => console.error(err));
        });
    </script>
</body>

</html>